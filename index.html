<!DOCTYPE html>
<html lang="pl">
<head>
    <link rel="apple-touch-icon" href="icon.png">
<link rel="icon" type="image/png" href="icon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>myMacro</title>
    <style>
        :root { --p: #007bff; --s: #28a745; --w: #ffc107; --d: #dc3545; --dark: #212529; --night: #6f42c1; }
        body { font-family: -apple-system, sans-serif; background: #f4f7f6; margin: 0; padding: 10px; color: var(--dark); padding-bottom: 50px; }
        .card { background: white; padding: 15px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); max-width: 500px; margin: auto; }
        
        .header-container { display: flex; align-items: center; justify-content: center; margin-bottom: 15px; gap: 10px; }
        h2 { margin: 0; font-size: 1.1rem; }
        .btn-ghost { background: #eee; border: 1px solid #ddd; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: bold; cursor: pointer; color: #666; }

        .section-title { font-size: 15px; font-weight: bold; margin: 20px 0 10px 0; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid var(--p); padding-left: 8px; }
        input { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 16px; }
        .grid-inputs { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }
        .time-row { display: flex; gap: 5px; align-items: center; margin: 10px 0; }
        
        button { width: 100%; padding: 14px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.2s; margin: 5px 0; font-size: 14px; }
        .btn-add { background: var(--p); color: white; }
        .btn-fav-toggle { background: var(--s); color: white; }
        
        /* Panel Ulubione */
        #fav-panel { display: none; background: #f8f9fa; padding: 15px; border-radius: 15px; border: 1px solid #eee; margin: 10px 0; }
        .fav-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; max-height: 200px; overflow-y: auto; }
        .fav-item { background: white; border: 1px solid #ddd; border-radius: 20px; padding: 5px 12px; font-size: 12px; display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .fav-del { color: var(--d); font-weight: bold; padding-left: 5px; border-left: 1px solid #eee; }

        /* Podsumowanie z paskami */
        .summary { margin: 15px 0; background: var(--dark); color: white; padding: 15px; border-radius: 15px; }
        .kcal-main { text-align: center; font-size: 22px; font-weight: bold; color: var(--w); display: block; margin-bottom: 5px; }
        .stat-row { margin-bottom: 8px; }
        .stat-label { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 3px; }
        .prog-bg { width: 100%; background: #444; border-radius: 10px; height: 6px; overflow: hidden; }
        .prog-fill { height: 100%; background: var(--s); width: 0%; transition: 0.5s; }
        
        /* Wykresy */
        .chart-box { background: #f8f9fa; padding: 10px; border-radius: 12px; border: 1px solid #eee; margin-bottom: 15px; }
        .chart-title { font-size: 11px; font-weight: bold; color: #444; text-transform: uppercase; display: flex; justify-content: space-between; margin-bottom: 15px; }
        .chart-container { display: flex; align-items: flex-end; justify-content: space-between; height: 80px; background: #f0f0f0; border-radius: 8px; padding: 5px 10px 20px 10px; position: relative; gap: 10px; }
        .chart-bar { flex: 1; border-radius: 3px 3px 0 0; position: relative; cursor: pointer; min-width: 20px; z-index: 2; }
        .chart-bar::after { content: attr(data-val); position: absolute; top: -22px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; font-size: 8px; padding: 2px 4px; border-radius: 3px; opacity: 0; pointer-events: none; transition: 0.1s; }
        .chart-bar:hover::after { opacity: 1; }
        .chart-date { position: absolute; bottom: -18px; left: 50%; transform: translateX(-50%); font-size: 8px; color: #888; }
        .avg-line { position: absolute; left: 0; right: 0; border-top: 1px dashed var(--d); z-index: 5; pointer-events: none; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
        td { padding: 10px 5px; border-bottom: 1px solid #eee; }
        .btn-del-row { color: var(--d); font-weight: bold; border: none; background: none; cursor: pointer; }
    </style>
</head>
<body>

<div class="card">
    <div class="header-container">
        <button class="btn-ghost" onclick="toggleElement('goals-panel')">CELE</button>
        <h2 id="current-date">----</h2>
    </div>

    <div id="goals-panel" style="display:none">
        <div class="grid-inputs">
            <div><small>Kcal</small><input type="number" id="goalKcal" onchange="saveSettings()"></div>
            <div><small>B</small><input type="number" id="goalP" onchange="saveSettings()"></div>
            <div><small>T</small><input type="number" id="goalF" onchange="saveSettings()"></div>
            <div><small>W</small><input type="number" id="goalC" onchange="saveSettings()"></div>
        </div>
    </div>
    
    <input type="text" id="name" placeholder="Co jemy?">
    <div class="grid-inputs" style="grid-template-columns: 1fr 1fr 1fr;">
        <input type="number" id="p" placeholder="Bia≈Çko">
        <input type="number" id="f" placeholder="T≈Çuszcz">
        <input type="number" id="c" placeholder="Wƒôgle">
    </div>
    <div class="time-row">
        <input type="time" id="mealTime" style="flex:1">
        <button onclick="setNow()" style="width:auto; padding:10px; background:#6c757d; color:white;">TERAZ</button>
    </div>
    
    <button class="btn-add" onclick="addItem()">DODAJ POSI≈ÅEK</button>
    <button class="btn-fav-toggle" onclick="toggleElement('fav-panel')">‚≠ê TWOJE ULUBIONE</button>
    <button class="btn-ghost" onclick="saveToFav()" style="font-size: 11px;">Zapisz powy≈ºsze jako ulubione</button>

    <div id="fav-panel">
        <input type="text" id="favSearch" placeholder="Szukaj w ulubionych..." oninput="renderFavs()">
        <div class="fav-container" id="favList"></div>
    </div>

    <div class="summary">
        <span class="kcal-main" id="txtKcal">0 / 0 kcal</span>
        <div class="stat-row"><div class="prog-bg"><div id="barKcal" class="prog-fill"></div></div></div>
        
        <div class="stat-row">
            <div class="stat-label"><span>Bia≈Çko</span><span id="txtP">0 / 0g</span></div>
            <div class="prog-bg"><div id="barP" class="prog-fill"></div></div>
        </div>
        <div class="stat-row">
            <div class="stat-label"><span>T≈Çuszcz</span><span id="txtF">0 / 0g</span></div>
            <div class="prog-bg"><div id="barF" class="prog-fill"></div></div>
        </div>
        <div class="stat-row">
            <div class="stat-label"><span>Wƒôglowodany</span><span id="txtC">0 / 0g</span></div>
            <div class="prog-bg"><div id="barC" class="prog-fill"></div></div>
        </div>
    </div>

    <table><tbody id="list"></tbody></table>

    <div class="section-title">üìä Raport 7 dni</div>
    <div class="chart-box"><div class="chart-title">Energia</div><div class="chart-container" id="chartKcal"></div></div>
    <div class="chart-box"><div class="chart-title">Bia≈Çko</div><div class="chart-container" id="chartP"></div></div>
    <div class="chart-box"><div class="chart-title">T≈Çuszcz</div><div class="chart-container" id="chartF"></div></div>
    <div class="chart-box"><div class="chart-title">Wƒôglowodany</div><div class="chart-container" id="chartC"></div></div>

    <div class="section-title">üåô Sen</div>
    <div class="chart-box">
        <div class="chart-title">Czas snu <span id="labelAvgSleep" style="color:var(--d)"></span></div>
        <div class="chart-container" id="chartSleep" style="height:60px;"></div>
        <div class="time-row" style="margin-top:15px">
            <input type="time" id="sleepStart" style="flex:1">
            <input type="time" id="sleepEnd" style="flex:1">
            <button onclick="addSleep()" style="width:auto; background:var(--night); color:white; padding:10px;">ZAPISZ</button>
        </div>
    </div>

    <button onclick="toggleBackup(true)" style="background:#eee; color:#666; font-size:10px;">‚öôÔ∏è Kopia zapasowa</button>
</div>

<div class="overlay" id="overlay" onclick="toggleBackup(false)"></div>
<div id="backup-modal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:20px; border-radius:20px; z-index:1000; width:90%; max-width:350px;">
    <h3>Kopia Danych</h3>
    <textarea id="backupData" rows="5" readonly onclick="this.select()" style="width:100%; font-size:10px;"></textarea>
    <button onclick="importData()" style="background:var(--p); color:white; margin-top:10px;">WGRAJ KOPIƒò</button>
</div>

<script>
    let history = JSON.parse(localStorage.getItem('macroHistory')) || {};
    let sleepData = JSON.parse(localStorage.getItem('sleepHistory')) || {};
    let favorites = JSON.parse(localStorage.getItem('macroFavs')) || [];
    let goals = JSON.parse(localStorage.getItem('macroGoals')) || { kcal: 2000, p: 150, f: 70, c: 200 };
    let todayKey = new Date().getHours() < 3 ? new Date(new Date().setDate(new Date().getDate()-1)).toISOString().split('T')[0] : new Date().toISOString().split('T')[0];

    function renderFavs() {
        const query = document.getElementById('favSearch').value.toLowerCase();
        const div = document.getElementById('favList');
        div.innerHTML = favorites
            .filter(f => f.name.toLowerCase().includes(query))
            .map((f, i) => `
                <div class="fav-item" onclick="addMealFromFav('${f.name}')">
                    ${f.name} <span class="fav-del" onclick="event.stopPropagation(); deleteFav('${f.name}')">‚úï</span>
                </div>
            `).join('');
    }

    function saveToFav() {
        const name = document.getElementById('name').value;
        const p = parseFloat(document.getElementById('p').value) || 0;
        const f = parseFloat(document.getElementById('f').value) || 0;
        const c = parseFloat(document.getElementById('c').value) || 0;
        if(!name) return;
        favorites.push({ name, p, f, c });
        localStorage.setItem('macroFavs', JSON.stringify(favorites));
        renderFavs();
    }

    function deleteFav(name) {
        favorites = favorites.filter(f => f.name !== name);
        localStorage.setItem('macroFavs', JSON.stringify(favorites));
        renderFavs();
    }

    function addMealFromFav(name) {
        const f = favorites.find(fav => fav.name === name);
        document.getElementById('name').value = f.name;
        document.getElementById('p').value = f.p;
        document.getElementById('f').value = f.f;
        document.getElementById('c').value = f.c;
        setNow();
        addItem();
        document.getElementById('fav-panel').style.display = 'none';
    }

    function setNow() {
        const now = new Date();
        document.getElementById('mealTime').value = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
    }

    function saveSettings() {
        goals = { 
            kcal: parseFloat(document.getElementById('goalKcal').value) || 2000, 
            p: parseFloat(document.getElementById('goalP').value) || 150, 
            f: parseFloat(document.getElementById('goalF').value) || 70, 
            c: parseFloat(document.getElementById('goalC').value) || 200 
        };
        localStorage.setItem('macroGoals', JSON.stringify(goals));
        render();
    }

    function addItem() {
        const p = parseFloat(document.getElementById('p').value) || 0;
        const f = parseFloat(document.getElementById('f').value) || 0;
        const c = parseFloat(document.getElementById('c').value) || 0;
        if (!history[todayKey]) history[todayKey] = [];
        history[todayKey].push({ id: Date.now(), name: document.getElementById('name').value || "Posi≈Çek", p, f, c, time: document.getElementById('mealTime').value });
        localStorage.setItem('macroHistory', JSON.stringify(history));
        render();
    }

    function addSleep() {
        const s = document.getElementById('sleepStart').value;
        const e = document.getElementById('sleepEnd').value;
        if(!s || !e) return;
        const sT = new Date(`2000-01-01T${s}`); let eT = new Date(`2000-01-01T${e}`);
        if(eT < sT) eT.setDate(eT.getDate() + 1);
        sleepData[todayKey] = { hours: (eT - sT) / 3600000 };
        localStorage.setItem('sleepHistory', JSON.stringify(sleepData));
        render();
    }

    function render() {
        const list = document.getElementById('list');
        const conts = { kcal: document.getElementById('chartKcal'), p: document.getElementById('chartP'), f: document.getElementById('chartF'), c: document.getElementById('chartC'), sleep: document.getElementById('chartSleep') };
        list.innerHTML = ""; Object.values(conts).forEach(c => c.innerHTML = "");
        
        let tP=0, tF=0, tC=0;
        (history[todayKey] || []).sort((a,b)=>a.time.localeCompare(b.time)).forEach(m => {
            tP+=m.p; tF+=m.f; tC+=m.c;
            list.innerHTML += `<tr><td><small>${m.time}</small> ${m.name}</td><td style="text-align:right">${m.p.toFixed(1)}|${m.f.toFixed(1)}|${m.c.toFixed(1)} <button class="btn-del-row" onclick="deleteItem(${m.id})">‚úï</button></td></tr>`;
        });

        const tk = tP*4 + tC*4 + tF*9;
        document.getElementById('txtKcal').innerText = `${tk.toFixed(1)} / ${goals.kcal} kcal`;
        document.getElementById('txtP').innerText = `${tP.toFixed(1)} / ${goals.p}g`;
        document.getElementById('txtF').innerText = `${tF.toFixed(1)} / ${goals.f}g`;
        document.getElementById('txtC').innerText = `${tC.toFixed(1)} / ${goals.c}g`;

        const updateProg = (id, cur, goal) => { document.getElementById('bar' + id).style.width = Math.min((cur/(goal||1))*100, 100) + "%"; };
        updateProg('Kcal', tk, goals.kcal); updateProg('P', tP, goals.p); updateProg('F', tF, goals.f); updateProg('C', tC, goals.c);

        const dates = []; for(let i=6; i>=0; i--) { const d = new Date(); d.setDate(d.getDate()-i); dates.push(d.toISOString().split('T')[0]); }
        let sS=0, cS=0;

        dates.forEach(d => {
            let dP=0, dF=0, dC=0; if(history[d]) { history[d].forEach(m=>{dP+=m.p; dF+=m.f; dC+=m.c;}); }
            let dK = dP*4 + dC*4 + dF*9;
            const bar = (c, v, g, cl, u) => {
                const pc = Math.min((v/(g||1))*100, 100) || 2;
                c.innerHTML += `<div class="chart-bar" style="height:${pc}%; background:${cl}" data-val="${v.toFixed(1)}${u}"><span class="chart-date">${d.slice(8)}.${d.slice(5,7)}</span></div>`;
            };
            bar(conts.kcal, dK, goals.kcal, 'var(--w)', ' kcal');
            bar(conts.p, dP, goals.p, 'var(--p)', 'g');
            bar(conts.f, dF, goals.f, 'var(--s)', 'g');
            bar(conts.c, dC, goals.c, 'var(--night)', 'g');
            let sH = sleepData[d] ? sleepData[d].hours : 0; if(sH>0){ sS+=sH; cS++; }
            bar(conts.sleep, sH, 12, 'var(--night)', 'h');
        });

        if(cS) { 
            let aS = sS/cS;
            document.getElementById('labelAvgSleep').innerText = `(≈õr: ${Math.floor(aS)}h ${Math.round((aS%1)*60)}m)`;
            conts.sleep.innerHTML += `<div class="avg-line" style="bottom:${Math.min((aS/12)*100, 100)}%"></div>`;
        }
        document.getElementById('backupData').value = btoa(JSON.stringify({ history, goals, sleepData, favorites }));
    }

    function deleteItem(id) { history[todayKey] = history[todayKey].filter(m=>m.id!==id); localStorage.setItem('macroHistory', JSON.stringify(history)); render(); }
    function toggleElement(id) { let e = document.getElementById(id); e.style.display = e.style.display==='none'?'block':'none'; }
    function toggleBackup(s) { document.getElementById('backup-modal').style.display = s?'block':'none'; document.getElementById('overlay').style.display = s?'none':'none'; }
    
    document.getElementById('goalKcal').value = goals.kcal;
    document.getElementById('goalP').value = goals.p;
    document.getElementById('goalF').value = goals.f;
    document.getElementById('goalC').value = goals.c;
    document.getElementById('current-date').innerText = "Dzie≈Ñ: " + todayKey;
    setNow(); renderFavs(); render();
</script>
</body>
</html>
